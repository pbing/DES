;;;; Cipher function

(in-package #:des)

(defun e (n)
  "E bit-selection table"
  (declare (type (unsigned-byte 32) n))
  (let ((w 0))
    (declare (type (unsigned-byte 48) w))
    (setf w (dpb (ldb (byte 1  0) n) (byte 1  47) w)
	  w (dpb (ldb (byte 5 27) n) (byte 5  42) w)
	  w (dpb (ldb (byte 6 23) n) (byte 6  36) w)
	  w (dpb (ldb (byte 6 19) n) (byte 6  30) w)
	  w (dpb (ldb (byte 6 15) n) (byte 6  24) w)
	  w (dpb (ldb (byte 6 11) n) (byte 6  18) w)
	  w (dpb (ldb (byte 6  7) n) (byte 6  12) w)
	  w (dpb (ldb (byte 6  3) n) (byte 6   6) w)
	  w (dpb (ldb (byte 5  0) n) (byte 5   1) w)
	  w (dpb (ldb (byte 1 31) n) (byte 1   0) w))
    w))

(defun p (n)
  "Permutation function P."
  (declare (type (unsigned-byte 32) n))
  (let ((w 0))
    (declare (type (unsigned-byte 32) w))
    (setf w (dpb (ldb (byte 1 16) n) (byte 1 31) w)
	  w (dpb (ldb (byte 1 25) n) (byte 1 30) w)
	  w (dpb (ldb (byte 1 12) n) (byte 1 29) w)
	  w (dpb (ldb (byte 1 11) n) (byte 1 28) w)

	  w (dpb (ldb (byte 1  3) n) (byte 1 27) w)
	  w (dpb (ldb (byte 1 20) n) (byte 1 26) w)
	  w (dpb (ldb (byte 1  4) n) (byte 1 25) w)
	  w (dpb (ldb (byte 1 15) n) (byte 1 24) w)

	  w (dpb (ldb (byte 1 31) n) (byte 1 23) w)
	  w (dpb (ldb (byte 1 17) n) (byte 1 22) w)
	  w (dpb (ldb (byte 1  9) n) (byte 1 21) w)
	  w (dpb (ldb (byte 1  6) n) (byte 1 20) w)

	  w (dpb (ldb (byte 1 27) n) (byte 1 19) w)
	  w (dpb (ldb (byte 1 14) n) (byte 1 18) w)
	  w (dpb (ldb (byte 1  1) n) (byte 1 17) w)
	  w (dpb (ldb (byte 1 22) n) (byte 1 16) w)

	  w (dpb (ldb (byte 1 30) n) (byte 1 15) w)
	  w (dpb (ldb (byte 1 24) n) (byte 1 14) w)
	  w (dpb (ldb (byte 1  8) n) (byte 1 13) w)
	  w (dpb (ldb (byte 1 18) n) (byte 1 12) w)

	  w (dpb (ldb (byte 1  0) n) (byte 1 11) w)
	  w (dpb (ldb (byte 1  5) n) (byte 1 10) w)
	  w (dpb (ldb (byte 1 29) n) (byte 1  9) w)
	  w (dpb (ldb (byte 1 23) n) (byte 1  8) w)

	  w (dpb (ldb (byte 1 13) n) (byte 1  7) w)
	  w (dpb (ldb (byte 1 19) n) (byte 1  6) w)
	  w (dpb (ldb (byte 1  2) n) (byte 1  5) w)
	  w (dpb (ldb (byte 1 26) n) (byte 1  4) w)

	  w (dpb (ldb (byte 1 10) n) (byte 1  3) w)
	  w (dpb (ldb (byte 1 21) n) (byte 1  2) w)
	  w (dpb (ldb (byte 1 28) n) (byte 1  1) w)
	  w (dpb (ldb (byte 1  7) n) (byte 1  0) w))
    w))

(defun f (r k)
  "Cipher function f."
  (declare (type (unsigned-byte 32) r)
	   (type (unsigned-byte 48) k))
  (let* ((exk (logxor (e r) k))
	 (s1 (s1 (ldb (byte 6 42) exk)))
	 (s2 (s2 (ldb (byte 6 36) exk)))
	 (s3 (s3 (ldb (byte 6 30) exk)))
	 (s4 (s4 (ldb (byte 6 24) exk)))
	 (s5 (s5 (ldb (byte 6 18) exk)))
	 (s6 (s6 (ldb (byte 6 12) exk)))
	 (s7 (s7 (ldb (byte 6  6) exk)))
	 (s8 (s8 (ldb (byte 6  0) exk))))
    (declare (type (unsigned-byte 48) exk)
	     (type (unsigned-byte 6) s1 s2 s3 s4 s5 s6 s7 s8))
    (let ((w 0))
      (declare (type (unsigned-byte 32) w))
      (setf w (dpb s1 (byte 4 28) w)
	    w (dpb s2 (byte 4 24) w)
	    w (dpb s3 (byte 4 20) w)
	    w (dpb s4 (byte 4 16) w)
	    w (dpb s5 (byte 4 12) w)
	    w (dpb s6 (byte 4  8) w)
	    w (dpb s7 (byte 4  4) w)
	    w (dpb s8 (byte 4  0) w))
      (the (unsigned-byte 32) (p w)))))
